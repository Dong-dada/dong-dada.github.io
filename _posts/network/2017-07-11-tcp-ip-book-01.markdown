---
layout: post
title:  "《TCP/IP 详解》学习 01 概述"
date:   2017-07-11 10:24:30 +0800
categories: network
---

* TOC
{:toc}


## 分层

TCP/IP 是一个协议族，是一组不同层次上的多个协议的组合。TCP/IP 通常被认为是一个四层协议系统，如下图所示：

![]( {{site.url}}/asset/tcp-ip-book-layer.png )

自底向上，每一层负责不同的功能：

- 链路层，有时也称为网络接口层，通常包含操作系统中的设备驱动程序和计算机中对应的网卡。它们一起处理与电缆的物理接口细节；
- 网络层，有时也称为互联网层，处理分组在网络中的活动，例如分组的选路。在 TCP/IP 协议族中，网络层协议包括 IP 协议 (网际协议)，ICMP 协议 (Internet 互联网控制报文协议)，以及 IGMP 协议 (Internet 组管理协议)；
- 运输层，主要为两台主机上的应用程序提供端到端的通信。在 TCP/IP 协议族中，有两个互不相同的传输协议：TCP(传输控制协议) 和 UDP(用户数据报协议)；
- 应用层，负责处理特定的应用程序细节，几乎各种不同的 TCP/IP 实现都会提供下面这些通用的应用程序：
    - Telnet 远程登录；
    - FTP 文件传输协议；
    - SMTP 简单邮件传送协议；
    - SNMP 简单网络管理协议；

举例来说，假如局域网中有两台主机，两者通过 FTP 协议进行通信，下图列出了该过程中涉及到的每一层协议：

![]( {{site.url}}/asset/tcp-ip-book-layer-sample.png )

### 为什么网络层和运输层需要分开？

上述四层协议中，链路层负责物理设备间的通信，应用层负责跟具体的应用程序打交道。然而中间的网络层和运输层，它们的区分不是那么明显，为什么要分成两层呢？

为了理解这一点，必须把视野从单个网络扩展到一组网络。例如下图中展示了一个包含两个网络的互联网，它们通过一个路由器互相连接：

![]( {{site.url}}/asset/software-debugging-ip-router-sample.png )

注意看上图，以太网和令牌环网之间通过一个路由器来进行连接，先不管以太网和令牌环网是什么，路由器是什么。从上图可以看出，网络层所提供的是点对点的连接，即 以太网主机 <--> 路由器 之间的连接通过网络层(IP 协议)来实现，同样的 路由器 <--> 令牌环网主机 之间的连接也是由网络层来实现。而运输层所提供的是端到端 (End-to-End) 的连接，即 以太网主机 <--> 令牌环网主机 之间的连接。

### 本书将要讨论的每一层的具体协议：

![]( {{site.url}}/asset/tcp-ip-book-protocal-layer.png )


## IP 地址

互联网上的每个接口都必须有一个唯一的 Internet 地址 (IP 地址)。IP 地址长 32 位，它分为 5 类：

![]( {{site.url}}/asset/tcp-ip-book-internet-address.png )

![]( {{site.url}}/asset/tcp-ip-book-ip-address-range.png )

注意，多接口主机有多个 IP 地址，每个接口都对应一个 IP 地址。

由于互联网上每个接口都有一个唯一的 IP 地址，因此必须有一个管理机构为接入互联网的网络分配 IP 地址。这个管理机构就是互联网网络信息中心 (Internet Network Information Centre)，简称 InterNIC, InterNIC 只分配网络号，主机号的分配由系统管理员来负责。

### 域名系统

IP 地址记起来比较繁琐，所以有了域名这回事。域名系统 (DNS, Domain Name System) 是一个数据库，用来记录 IP 和主机名之间的映射关系。


## 封装

当应用程序通过 TCP 传送数据时，数据被送到协议栈中，然后逐个通过每一层直到被当做一串比特流送入网络。其中每一层对收到的数据都要增加一些首部信息(有时还会增加尾部信息)，该过程如下图所示：

![]( {{site.url}}/asset/tcp-ip-book-data-package.png )

TCP 传给 IP 的数据单元称做 TCP 报文段或者简称为 TCP 段 (TCP segment), IP 传给链路层的数据单元称做 IP 数据报 (IP datagram), 通过以太网传输的比特流称为帧 (Frame)。

更准确地说，在 IP 和链路层之间传送的数据单元应该是分组 (packet), 分组既可以是一个 IP datagram, 也可以是 IP datagram 的一个片 fragment。

由于 TCP, UDP, ICMP, IGMP 都要向 IP 传送数据，因此 IP 必须在它的首部加入某些标识，以表明数据属于哪种协议发过来的。为此，IP 协议会在首部存入一个长度为 8 bit 的数值，称为协议域, 1 标识 ICMP 协议，2 标识 IGMP 协议，6 表示 TCP 协议，17 表示 UDP 协议。

类似的，许多程序都可以通过 TCP 或 UDP 来传送数据，运输层协议在生成报文首部的时候要存入一个应用程序的标识。TCP 和 UDP 都用一个 16 bit 的 **端口号** 来表示不同的应用程序。它会把源端口号和目标端口号分别存入到报文首部中。

类似的，链路层分别要发送和接收 IP, ARP 和 RARP 数据，因此以太网的帧首部也有一个 16 bit 的帧类型域。


## 分用

当目的主机收到一个以太网数据帧时，数据就开始从协议栈由底向上升，同时去掉各层协议加上的报文首部。每层协议盒都要去检查报文首部中的协议标识，以确定接收数据的上层协议是什么。这个过程被称为分用 (Demultiplexing)：

![]( {{site.url}}/asset/tcp-ip-book-demultiplexing.png )


## 端口号

之前介绍过，TCP 和 UDP 采用 16 bit 的端口号来识别应用程序，那么这些端口号是如何选择的呢？

服务器上的服务程序一般是通过知名端口号来识别的。例如 FTP 服务的 TCP 端口号都是 21, Telnet 的 TCP 端口号都是 23, TFTP 服务的端口号都是 69. 这些知名端口号介于 1 ~ 1023 之间。

客户端通常对自己的端口号并不关心，只需要保证端口号在主机上是唯一的就可以了，因此客户端端口号又称为临时端口号。大多数 TCP/IP 实现给临时端口号分配的区间介于 1024 ~ 50000 之间。


## 互联网

之前的章节中我们列举了一个由两个网络组成的互联网。而世界范围内的互联网被称为 Internet. 注意首字母需要大写。首字母小写的 internet 意思是通过一个共同的协议族把多个网络连接在一起。而 Internet 指的是世界范围内通过 TCP/IP 互相通信的所有主机集合。Internet 是一个 internet, 但 internet 不等于 Internet。

