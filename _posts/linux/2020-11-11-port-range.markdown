---
layout: post
title:  "Linux - port range"
date:   2020-11-11 15:54:30 +0800
categories: linux
---

* TOC
{:toc}

linux 下有个 port range 参数，指定了每次随机分配端口号时候的范围：

```s
# 查看当前端口号范围
$sysctl net.ipv4.ip_local_port_range
net.ipv4.ip_local_port_range = 20000 61000

# 修改端口号范围
sysctl -w net.ipv4.ip_local_port_range="20000 61001"
net.ipv4.ip_local_port_range = 20000 61001
```

如果端口号范围满了，那么建连会失败。有一次在线上发现连接到达了 50000 多，然后通过 `ulimit -n` 命令查看可打开的文件数，发现这个文件很大，应该不是 fd 不够用导致的。

然后就通过上面的命令查看了端口号分配范围，发现可用区间大概是 30000 左右。

连接数里的 50000，包括了 connect 其他机器生成的连接(这时候会随机分配端口号)，也包括了其它机器连接当前机器产生的连接。所以 50000 > 30000 是合理的。

为了验证是否是因为端口号分配完导致了连接失败。我在线下机器做了实验，通过上面的命令把端口号范围设置成了 [20000, 20010]，然后尝试建连，果然在建立第 12 条连接的时候发生了连接失败。

总的来说，一个机器可以建立多少条连接，与 port range 也有关系，以后排查问题可以优先考虑下这一点。